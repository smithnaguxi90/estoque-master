<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Sistema profissional de controle de estoque com todas as funcionalidades ativadas."
    />
    <title>EstoqueMaster | Controle de Material</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>"
    />

    <!-- Font Awesome 4 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
      xintegrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      /* === FONTE === */
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      /* === VARI√ÅVEIS DE DESIGN === */
      :root {
        /* Tema Claro (Azul Corporativo) */
        --color-primary: #2563eb;
        --color-primary-50: #eff6ff;
        --color-primary-700: #1d4ed8;

        /* Cores de status */
        --color-success: #10b981;
        --color-warning: #f59e0b;
        --color-danger: #ef4444;

        /* Cores Neutras (Claro) */
        --color-white: #ffffff;
        --color-bg: #f3f4f6;
        --color-card: #ffffff;
        --color-text-main: #111827;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;

        --color-shadow: rgba(0, 0, 0, 0.08);

        /* Configura√ß√µes */
        --border-radius: 0.75rem;
        --transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        --container-padding: 1.5rem;
      }

      /* === TEMA ESCURO (PALETA SPOTIFY) === */
      .dark-theme {
        /* Verde Spotify */
        --color-primary: #1db954;
        --color-primary-50: #113a1f;
        --color-primary-700: #1ed760;

        /* Pretos e Cinzas */
        --color-white: #121212; /* Fundo Geral */
        --color-bg: #000000; /* Fundo Body */
        --color-card: #181818; /* Cards */
        --color-text-main: #ffffff; /* Texto Principal */
        --color-text-muted: #b3b3b3; /* Texto Secund√°rio */
        --color-border: #282828; /* Bordas */

        --color-shadow: rgba(0, 0, 0, 0.5);
      }

      /* === RESET & GERAL === */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        font-size: 14px;
      }
      body {
        font-family: "Poppins", system-ui, sans-serif;
        background-color: var(--color-bg);
        color: var(--color-text-main);
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
        overflow-x: hidden;
        min-height: 100vh;
      }

      /* === LAYOUT === */
      .app-container {
        display: grid;
        grid-template-columns: 18.5rem 1fr;
        height: 100vh;
        max-width: 100%;
        transition: grid-template-columns 0.3s ease;
      }
      main {
        padding: 1.25rem;
        overflow-y: auto;
      }

      .card {
        background: var(--color-card);
        border-radius: var(--border-radius);
        padding: var(--container-padding);
        box-shadow: 0 4px 12px var(--color-shadow);
        transition: background-color 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 6px 16px var(--color-shadow);
      }

      /* === SIDEBAR === */
      aside {
        background: var(--color-card);
        height: 100vh;
        position: sticky;
        top: 0;
        border-right: 1px solid var(--color-border);
        z-index: 100;
        transition: width 0.3s ease;
        overflow-x: hidden;
      }
      .logo {
        padding: 1.25rem var(--container-padding);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border-bottom: 1px solid var(--color-border);
        white-space: nowrap;
      }
      .logo .logo-link {
        text-decoration: none;
        color: inherit;
        cursor: pointer;
      }
      .logo h1 {
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--color-primary);
      }
      .logo .danger {
        color: var(--color-danger);
      }

      .nav-menu {
        padding: 1rem 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      /* === ITENS DO MENU === */
      .nav-item {
        padding: 0.75rem 0.5rem 0.75rem 2.25rem;
        display: flex;
        align-items: center;
        gap: 0.875rem;
        color: var(--color-text-muted);
        font-weight: 500;
        text-decoration: none;
        transition: var(--transition);
        cursor: pointer;
        height: 2.875rem;
        position: relative;
        white-space: nowrap;
      }
      .nav-item:hover,
      .nav-item.active {
        color: var(--color-primary);
        background: var(--color-primary-50);
      }
      .dark-theme .nav-item:hover,
      .dark-theme .nav-item.active {
        background: var(--color-border);
      }
      .nav-item.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--color-primary);
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
      }
      .nav-item .fa {
        font-size: 1.3rem;
        width: 1.5em;
        text-align: center;
      }

      /* === SUBMENU === */
      .nav-header.collapsible {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1.5rem 0.75rem 2.25rem;
        color: var(--color-text-muted);
        font-weight: 600;
        gap: 0.875rem;
        transition: var(--transition);
        height: 2.875rem;
        white-space: nowrap;
      }
      .nav-header.collapsible:hover {
        color: var(--color-primary);
        background: var(--color-primary-50);
      }
      .dark-theme .nav-header.collapsible:hover {
        background: var(--color-border);
      }
      .arrow {
        transition: transform 0.3s ease;
        font-size: 1.1rem;
      }
      .arrow.rotate {
        transform: rotate(180deg);
      }

      .submenu {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.2s ease;
        max-height: 0;
        opacity: 0;
      }
      .submenu.open {
        max-height: 600px;
        opacity: 1;
      }
      .submenu .nav-item {
        padding-left: 3.125rem;
        font-size: 0.925rem;
        height: 2.875rem;
      }

      /* === TOP BAR === */
      .top-bar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .menu-toggle {
        display: none;
        font-size: 1.75rem;
        color: var(--color-text-muted);
        cursor: pointer;
      }
      .theme-toggle {
        display: flex;
        gap: 0.5rem;
      }
      .theme-toggle button {
        background: transparent;
        border: none;
        width: 32px;
        height: 32px;
        color: var(--color-text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1.2rem;
        transition: var(--transition);
      }
      .theme-toggle button:hover {
        background: var(--color-border);
      }
      .theme-toggle button.active {
        background: var(--color-primary-50);
        color: var(--color-primary);
      }
      .dark-theme .theme-toggle button.active {
        background: var(--color-primary);
        color: var(--color-white);
      }

      /* === DASHBOARD & STATS === */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.5rem;
      }
      .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .stat-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
      }
      .stat-primary {
        background: var(--color-primary);
      }
      .stat-danger {
        background: var(--color-danger);
      }
      .stat-success {
        background: var(--color-success);
      }

      .stat-content h3 {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        margin-bottom: 0.25rem;
      }
      .stat-content .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text-main);
      }

      /* === TABELA === */
      .table-container {
        overflow-x: auto;
        margin-top: 1rem;
        -webkit-overflow-scrolling: touch;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
      }
      thead th {
        padding: 0.75rem 1rem;
        font-weight: 600;
        color: var(--color-text-muted);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap; /* Garante que cabe√ßalhos n√£o quebrem de forma feia */
      }
      tbody td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--color-border);
        color: var(--color-text-main);
        white-space: nowrap; /* Evita quebra de linha em dados curtos */
      }
      .status {
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
      }
      .status-success {
        background: var(--color-success);
      }
      .status-warning {
        background: var(--color-warning);
      }
      .status-danger {
        background: var(--color-danger);
      }

      .view-details {
        text-decoration: none;
        color: inherit;
        font-weight: 500;
        transition: var(--transition);
      }
      .view-details:hover {
        color: var(--color-primary);
        text-decoration: underline;
      }

      /* === FORMUL√ÅRIO === */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
      }
      .form-grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.25rem;
      }
      .form-group {
        margin-bottom: 1.25rem;
      }
      .form-group-full {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--color-text-muted);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--color-text-muted);
        border-radius: var(--border-radius);
        background: var(--color-card);
        font-family: inherit;
        font-size: 0.925rem;
        color: var(--color-text-main);
        opacity: 0.9;
      }
      .dark-theme input,
      .dark-theme select,
      .dark-theme textarea {
        border-color: var(--color-border);
        opacity: 1;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }
      .dark-theme input:focus,
      .dark-theme select:focus,
      .dark-theme textarea:focus {
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.3);
      }

      /* Bot√µes */
      .btn {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.925rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .btn .fa {
        font-size: 1.1rem;
      }

      .btn-primary {
        background: var(--color-primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--color-primary-700);
      }

      .btn-secondary {
        background: var(--color-border);
        color: var(--color-text-main);
      }
      .dark-theme .btn-secondary:hover {
        background: var(--color-text-muted);
      }

      .btn-danger {
        background: var(--color-danger);
        color: white;
      }
      .btn-danger:hover {
        filter: brightness(0.9);
      }

      .btn-success {
        background: var(--color-success);
        color: white;
      }
      .btn-success:hover {
        filter: brightness(0.9);
      }

      /* === CHART === */
      .chart-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1rem;
      }
      .chart-row {
        display: grid;
        grid-template-columns: 120px 1fr 40px;
        align-items: center;
        gap: 1rem;
      }
      .chart-label {
        font-weight: 500;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--color-text-muted);
      }
      .chart-bar-background {
        background: var(--color-border);
        border-radius: var(--border-radius);
        height: 1.25rem;
        overflow: hidden;
      }
      .chart-bar {
        background: var(--color-primary);
        height: 100%;
        border-radius: var(--border-radius);
        transition: width 0.5s ease;
      }
      .chart-value {
        font-weight: 600;
        font-size: 0.9rem;
        text-align: right;
        color: var(--color-text-main);
      }

      /* SKU Feedback */
      #movement-material-name {
        margin-top: 0.5rem;
        font-weight: 500;
        transition: color var(--transition);
      }
      #movement-material-name.success {
        color: var(--color-success);
      }
      #movement-material-name.danger {
        color: var(--color-danger);
      }
      #movement-material-name.neutral {
        color: var(--color-text-muted);
      }

      /* === TOAST === */
      #toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        width: 320px;
        max-width: 90%;
      }
      .toast {
        background: var(--color-card);
        color: var(--color-text-main);
        border-radius: var(--border-radius);
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 12px var(--color-shadow);
        border-left: 4px solid var(--color-primary);
        animation: toastFadeIn 0.3s ease forwards,
          toastFadeOut 0.3s ease 2.7s forwards;
        opacity: 0;
        font-weight: 500;
      }
      .toast-success {
        border-left-color: var(--color-success);
      }
      .toast-danger {
        border-left-color: var(--color-danger);
      }
      .toast-warning {
        border-left-color: var(--color-warning);
      }

      @keyframes toastFadeIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes toastFadeOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      /* === MODAL === */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }
      .modal-content {
        position: relative;
        background: var(--color-card);
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1001;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem var(--container-padding);
        border-bottom: 1px solid var(--color-border);
      }
      .modal-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-main);
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.75rem;
        color: var(--color-text-muted);
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
      }
      .modal-close:hover {
        background: var(--color-border);
        color: var(--color-text-main);
      }
      .modal-body {
        padding: var(--container-padding);
      }
      .modal-body p {
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        color: var(--color-text-main);
      }
      .modal-body strong {
        color: var(--color-text-main);
      }
      .modal-footer {
        padding: 0 var(--container-padding) 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
      }
      .modal.fade-in {
        animation: modalFadeIn 0.3s ease forwards;
      }
      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .section-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
        color: var(--color-text-main);
      }

      /* === RESPONSIVO (3 Est√°gios) === */
      /* Tablet (1024px) */
      @media (max-width: 1024px) {
        .app-container {
          grid-template-columns: 5rem 1fr;
        }
        aside .logo h1,
        aside .nav-item span,
        aside .arrow {
          display: none;
        }
        aside .nav-item,
        aside .nav-header {
          padding-left: 0;
          padding-right: 0;
          justify-content: center;
        }
        aside .nav-item .fa {
          margin-right: 0;
        }
        .submenu .nav-item {
          padding-left: 0;
          justify-content: center;
        }
        .submenu .nav-item::before {
          display: none;
        }
        .form-grid-4 {
          grid-template-columns: 1fr 1fr;
        }
      }
      /* Mobile (768px) */
      @media (max-width: 768px) {
        .app-container {
          grid-template-columns: 1fr;
        }
        aside {
          position: fixed;
          left: -100%;
          width: 18.5rem;
          transition: left 0.3s ease;
          z-index: 1000;
          background: var(--color-card);
        }
        aside.open {
          left: 0;
        }
        aside.open .logo h1,
        aside.open .nav-item span,
        aside.open .arrow {
          display: inline-block;
        }
        aside.open .nav-item {
          padding: 0.75rem 0.5rem 0.75rem 2.25rem;
          justify-content: flex-start;
        }
        aside.open .nav-header {
          padding: 0.75rem 1.5rem 0.75rem 2.25rem;
          justify-content: space-between;
        }
        aside.open .submenu .nav-item {
          padding-left: 3.125rem;
          justify-content: flex-start;
        }
        .menu-toggle {
          display: block;
        }
        main {
          padding: 1rem;
        }
        .form-grid,
        .form-grid-4 {
          grid-template-columns: 1fr;
        }
        .chart-row {
          grid-template-columns: 1fr;
          gap: 0.25rem;
          text-align: center;
        }
        .chart-label {
          white-space: normal;
        }
        .chart-value {
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- SIDEBAR -->
      <aside id="sidebar">
        <div class="logo">
          <a href="#" data-target="dashboard" class="logo-link">
            <h1>Estoque<span class="danger">Master</span></h1>
          </a>
        </div>
        <nav class="nav-menu">
          <a href="#" class="nav-item active" data-target="dashboard">
            <i class="fa fa-dashboard" aria-hidden="true"></i>
            <span>Dashboard</span>
          </a>
          <div class="nav-header collapsible" data-target="material-submenu">
            <i class="fa fa-archive" aria-hidden="true"></i>
            <span>Material</span>
            <i class="fa fa-chevron-down arrow rotate" aria-hidden="true"></i>
          </div>
          <ul class="submenu open" id="material-submenu">
            <li>
              <a href="#" class="nav-item" data-target="search-material"
                >Pesquisa de Material</a
              >
            </li>
            <li>
              <a href="#" class="nav-item" data-target="stock-search"
                >Pesquisa de Estoque</a
              >
            </li>
            <li>
              <a href="#" class="nav-item" data-target="stock-movement"
                >Movimenta√ß√£o de Estoque</a
              >
            </li>
            <li>
              <a href="#" class="nav-item" data-target="movement-search"
                >Pesquisa de Movimenta√ß√£o</a
              >
            </li>
            <li>
              <a href="#" class="nav-item" data-target="material-reports"
                >Relat√≥rios de Material</a
              >
            </li>
            <li>
              <a href="#" class="nav-item" data-target="add-material"
                >Cadastro de Material</a
              >
            </li>
          </ul>
          <div class="nav-header collapsible" data-target="reports-submenu">
            <i class="fa fa-file-text-o" aria-hidden="true"></i>
            <span>Relat√≥rios</span>
            <i class="fa fa-chevron-down arrow" aria-hidden="true"></i>
          </div>
          <ul class="submenu" id="reports-submenu">
            <li>
              <a href="#" class="nav-item" data-target="material-reports"
                >Relat√≥rios de Material</a
              >
            </li>
          </ul>
          <a href="#" class="nav-item" data-target="settings">
            <i class="fa fa-cog" aria-hidden="true"></i>
            <span>Configura√ß√µes</span>
          </a>
          <a href="#" class="nav-item" id="logout-btn">
            <i class="fa fa-sign-out" aria-hidden="true"></i>
            <span>Sair</span>
          </a>
        </nav>
      </aside>

      <!-- CONTE√öDO PRINCIPAL -->
      <main>
        <div class="top-bar">
          <i
            class="fa fa-bars menu-toggle"
            id="menu-toggle"
            aria-hidden="true"
          ></i>
          <div
            class="theme-toggle"
            id="theme-toggle"
            aria-label="Escolha o tema"
          >
            <button id="btn-theme-light" class="active" aria-label="Modo claro">
              <i class="fa fa-sun-o" aria-hidden="true"></i>
            </button>
            <button id="btn-theme-dark" aria-label="Modo escuro">
              <i class="fa fa-moon-o" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="content-section fade-in">
          <h2 class="section-title">Dashboard</h2>
          <div class="stats-grid">
            <div class="card stat-card">
              <div class="stat-icon stat-primary">
                <i class="fa fa-archive"></i>
              </div>
              <div class="stat-content">
                <h3>Total de Itens</h3>
                <div class="value" id="total-items">0</div>
                <div
                  style="
                    font-size: 0.75rem;
                    color: var(--color-text-muted);
                    margin-top: 0.25rem;
                  "
                >
                  √öltimas 24h
                </div>
              </div>
            </div>
            <div class="card stat-card">
              <div class="stat-icon stat-success">
                <i class="fa fa-exclamation-triangle"></i>
              </div>
              <div class="stat-content">
                <h3>Abaixo do M√≠nimo</h3>
                <div class="value" id="low-stock">0</div>
                <div
                  style="
                    font-size: 0.75rem;
                    color: var(--color-text-muted);
                    margin-top: 0.25rem;
                  "
                >
                  √öltimas 24h
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-bottom: 1rem; font-weight: 600">
              Materiais Recentes
            </h3>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Material</th>
                    <th>C√≥d. Almox.</th>
                    <th>Qtd.</th>
                    <th>Status</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="recent-materials"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CADASTRO -->
        <section
          id="add-material"
          class="content-section"
          style="display: none"
        >
          <h2 class="section-title">Cadastro de Material</h2>
          <div class="card">
            <form id="material-form">
              <input type="hidden" id="material-id" />
              <div class="form-group form-group-full">
                <label for="material-name">Nome do Material</label>
                <input type="text" id="material-name" required />
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="material-sku">C√ìDIGO ALMOXARIFADO</label>
                  <input type="text" id="material-sku" required />
                </div>
                <div class="form-group">
                  <label for="material-category">Categoria</label>
                  <select id="material-category" required>
                    <option value="">Selecione</option>
                    <option value="carpetes">CARPETES</option>
                    <option value="chaves">CHAVES</option>
                    <option value="construcao">CONSTRU√á√ÉO</option>
                    <option value="equipamentos">EQUIPAMENTOS</option>
                    <option value="estrutural">ESTRUTURAL</option>
                    <option value="ferramentas">FERRAMENTAS</option>
                    <option value="gesso">GESSO</option>
                    <option value="impermeabilizacao">IMPERMEABILIZA√á√ÉO</option>
                    <option value="marcenaria">MARCENARIA</option>
                    <option value="marmoraria">MARMORARIA</option>
                    <option value="materiais">MATERIAIS</option>
                    <option value="pavimentacao">PAVIMENTA√á√ÉO</option>
                    <option value="persianas">PERSIANAS</option>
                    <option value="pintura">PINTURA</option>
                    <option value="piso-vinilicos">PISO VIN√çLICOS</option>
                    <option value="protecao">PROTE√á√ÉO</option>
                    <option value="serralheria">SERRALHERIA</option>
                    <option value="tapecaria">TAPE√áARIA</option>
                    <option value="vidracaria">VIDRA√áARIA</option>
                  </select>
                </div>
              </div>
              <div class="form-grid-4">
                <div class="form-group">
                  <label for="material-quantity">Qtd. Atual</label>
                  <input
                    type="number"
                    id="material-quantity"
                    min="0"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="material-min-quantity">Qtd. M√≠nima</label>
                  <input
                    type="number"
                    id="material-min-quantity"
                    min="0"
                    value="0"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="material-resupply-quantity"
                    >Qtd. Ressuprimento</label
                  >
                  <input
                    type="number"
                    id="material-resupply-quantity"
                    min="0"
                    value="0"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="material-alert-percentage">% Alerta</label>
                  <input
                    type="number"
                    id="material-alert-percentage"
                    min="0"
                    max="100"
                    value="40"
                    required
                  />
                </div>
              </div>
              <div class="form-group form-group-full">
                <label for="material-description">Descri√ß√£o</label>
                <textarea id="material-description" rows="3"></textarea>
              </div>
              <div
                class="form-group-full"
                style="display: flex; gap: 0.75rem; margin-top: 1rem"
              >
                <button type="submit" class="btn btn-primary">
                  Salvar Material
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="form-cancel"
                >
                  Cancelar
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- PESQUISA MATERIAL -->
        <section
          id="search-material"
          class="content-section"
          style="display: none"
        >
          <h2 class="section-title">Pesquisa de Material</h2>
          <div class="card">
            <div class="form-grid">
              <div class="form-group">
                <label for="search-category-filter"
                  >Filtrar por Categoria</label
                >
                <select id="search-category-filter">
                  <option value="all">Todas as Categorias</option>
                  <option value="carpetes">CARPETES</option>
                  <option value="chaves">CHAVES</option>
                  <option value="construcao">CONSTRU√á√ÉO</option>
                  <option value="equipamentos">EQUIPAMENTOS</option>
                  <option value="estrutural">ESTRUTURAL</option>
                  <option value="ferramentas">FERRAMENTAS</option>
                  <option value="gesso">GESSO</option>
                  <option value="impermeabilizacao">IMPERMEABILIZA√á√ÉO</option>
                  <option value="marcenaria">MARCENARIA</option>
                  <option value="marmoraria">MARMORARIA</option>
                  <option value="materiais">MATERIAIS</option>
                  <option value="pavimentacao">PAVIMENTA√á√ÉO</option>
                  <option value="persianas">PERSIANAS</option>
                  <option value="pintura">PINTURA</option>
                  <option value="piso-vinilicos">PISO VIN√çLICOS</option>
                  <option value="protecao">PROTE√á√ÉO</option>
                  <option value="serralheria">SERRALHERIA</option>
                  <option value="tapecaria">TAPE√áARIA</option>
                  <option value="vidracaria">VIDRA√áARIA</option>
                </select>
              </div>
              <div class="form-group">
                <label for="search-sort-filter">Ordenar por</label>
                <select id="search-sort-filter">
                  <option value="name-asc">Nome (A-Z)</option>
                  <option value="name-desc">Nome (Z-A)</option>
                  <option value="qty-desc">Quantidade (Maior-Menor)</option>
                  <option value="qty-asc">Quantidade (Menor-Maior)</option>
                </select>
              </div>
            </div>
            <div class="form-group form-group-full">
              <label for="search-material-input"
                >Buscar por nome ou C√≥d. Almox.</label
              >
              <input
                type="text"
                id="search-material-input"
                placeholder="Ex: Furadeira, 85631..."
              />
            </div>
            <div class="form-group form-group-full">
              <label
                style="
                  font-weight: 500;
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                "
              >
                <input
                  type="checkbox"
                  id="search-show-archived"
                  style="width: auto"
                />
                Mostrar itens arquivados
              </label>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Material</th>
                    <th>C√≥d. Almox.</th>
                    <th>Categoria</th>
                    <th>Qtd.</th>
                    <th>M√≠n.</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="search-material-results"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ESTOQUE -->
        <section
          id="stock-search"
          class="content-section"
          style="display: none"
        >
          <h2 class="section-title">Pesquisa de Estoque</h2>
          <div class="card">
            <div class="form-group">
              <label for="stock-status-filter">Filtrar por Status</label>
              <select id="stock-status-filter">
                <option value="all">Mostrar Todos</option>
                <option value="attention">
                  Requer Aten√ß√£o (Ressuprimento)
                </option>
                <option value="critical">
                  Estoque Cr√≠tico (Abaixo do M√≠nimo)
                </option>
                <option value="out">Sem Estoque</option>
              </select>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Material</th>
                    <th>Qtd. Atual</th>
                    <th>Qtd. M√≠nima</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="stock-search-results"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- MOVIMENTA√á√ÉO -->
        <section
          id="stock-movement"
          class="content-section"
          style="display: none"
        >
          <h2 class="section-title">Movimenta√ß√£o de Estoque</h2>
          <div class="card">
            <form id="movement-form">
              <div class="form-group">
                <label for="movement-sku-input">C√ìDIGO ALMOXARIFADO</label>
                <input
                  type="text"
                  id="movement-sku-input"
                  placeholder="Digite o c√≥digo..."
                  required
                />
                <p id="movement-material-name" class="neutral">
                  Digite o c√≥digo do material.
                </p>
              </div>
              <div class="form-group">
                <label>Tipo de Movimenta√ß√£o</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem">
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      font-weight: 500;
                    "
                  >
                    <input
                      type="radio"
                      name="movement-type"
                      value="entrada"
                      required
                      style="width: auto"
                    />
                    Entrada
                  </label>
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      font-weight: 500;
                    "
                  >
                    <input
                      type="radio"
                      name="movement-type"
                      value="saida"
                      required
                      style="width: auto"
                    />
                    Sa√≠da
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label for="movement-quantity">Quantidade</label>
                <input type="number" id="movement-quantity" min="1" required />
              </div>
              <div class="form-group">
                <label for="movement-reason">Motivo</label>
                <textarea
                  id="movement-reason"
                  rows="2"
                  placeholder="Ex: Compra, Manuten√ß√£o..."
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                Registrar Movimenta√ß√£o
              </button>
            </form>
          </div>
        </section>

        <!-- PESQUISA MOVIMENTA√á√ÉO -->
        <section
          id="movement-search"
          class="content-section"
          style="display: none"
        >
          <h2 class="section-title">Pesquisa de Movimenta√ß√£o</h2>
          <div class="card">
            <div class="form-group">
              <label for="movement-search-date">Filtrar por data</label>
              <input type="date" id="movement-search-date" />
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Material</th>
                    <th>Tipo</th>
                    <th>Qtd.</th>
                    <th>Motivo</th>
                  </tr>
                </thead>
                <tbody id="movement-search-results"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- RELAT√ìRIOS -->
        <section
          id="material-reports"
          class="content-section"
          style="display: none"
        >
          <h2 class="section-title">Relat√≥rios de Material</h2>
          <div class="stats-grid">
            <div class="card stat-card">
              <div class="stat-icon stat-primary">
                <i class="fa fa-archive"></i>
              </div>
              <div class="stat-content">
                <h3>Total de Materiais</h3>
                <div class="value" id="report-total-materials">0</div>
              </div>
            </div>
            <div class="card stat-card">
              <div class="stat-icon stat-danger">
                <i class="fa fa-arrow-down"></i>
              </div>
              <div class="stat-content">
                <h3>Itens sem Estoque</h3>
                <div class="value" id="report-out-of-stock">0</div>
              </div>
            </div>
            <div class="card stat-card">
              <div class="stat-icon stat-success">
                <i class="fa fa-arrow-up"></i>
              </div>
              <div class="stat-content">
                <h3>Itens com Estoque Alto</h3>
                <div class="value" id="report-high-stock">0</div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top: 1.5rem">
            <h3 style="margin-bottom: 0.5rem">Itens por Categoria</h3>
            <div id="category-chart-container" class="chart-container"></div>
          </div>
          <div class="card" style="margin-top: 1.5rem">
            <h3 style="margin-bottom: 1rem">
              Top 3 Materiais Mais Movimentados
            </h3>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Material</th>
                    <th>Total Movimentado</th>
                  </tr>
                </thead>
                <tbody id="top-movements-report"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CONFIGURA√á√ïES -->
        <section id="settings" class="content-section" style="display: none">
          <h2 class="section-title">Configura√ß√µes</h2>
          <div class="card" style="margin-bottom: 1.5rem">
            <h3>Importar & Exportar Backup (JSON)</h3>
            <p
              style="
                margin-top: 0.5rem;
                margin-bottom: 1.25rem;
                color: var(--color-text-muted);
              "
            >
              Exporte um backup completo ou importe um arquivo .json.
            </p>
            <div style="display: flex; gap: 1rem; align-items: center">
              <button class="btn btn-primary" id="export-data-btn">
                <i class="fa fa-download"></i> Exportar Backup
              </button>
              <input
                type="file"
                id="import-file-input"
                accept=".json"
                style="display: none"
              />
              <label
                for="import-file-input"
                class="btn btn-secondary"
                style="display: flex; align-items: center; cursor: pointer"
              >
                <i class="fa fa-upload"></i> Importar Backup
              </label>
            </div>
            <p
              style="
                margin-top: 1rem;
                font-size: 0.875rem;
                color: var(--color-warning);
              "
            >
              <strong>Aten√ß√£o:</strong> A importa√ß√£o substituir√° todos os dados.
            </p>
          </div>
          <div class="card">
            <h3>Redefinir Dados</h3>
            <p
              style="
                margin-top: 0.5rem;
                margin-bottom: 1.25rem;
                color: var(--color-text-muted);
              "
            >
              Apagar todos os dados e restaurar o exemplo original.
            </p>
            <button class="btn btn-danger" id="reset-data-btn">
              Redefinir Dados Agora
            </button>
          </div>
        </section>
      </main>

      <!-- MODAL -->
      <div id="material-modal" class="modal" style="display: none">
        <div class="modal-overlay" data-close></div>
        <div class="modal-content">
          <div class="modal-header">
            <h3>Detalhes do Material</h3>
            <button class="modal-close" data-close>&times;</button>
          </div>
          <div class="modal-body" id="modal-body"></div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="print-modal">Imprimir</button>
            <div style="display: flex; gap: 0.5rem">
              <button class="btn btn-secondary" id="edit-material">
                Editar
              </button>
              <button class="btn btn-danger" id="archive-material">
                Arquivar
              </button>
              <button
                class="btn btn-success"
                id="unarchive-material"
                style="display: none"
              >
                Restaurar
              </button>
              <button class="btn btn-secondary" data-close>Fechar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-container"></div>

    <!-- SCRIPT EM BLOCO √öNICO -->
    <script>
      // === UTILS ===
      const $ = (selector) => document.querySelector(selector);
      const $$ = (selector) => document.querySelectorAll(selector);
      const NUMBER_FORMAT = new Intl.NumberFormat("pt-BR");

      const CATEGORY_MAP = {
        carpetes: "Carpetes",
        chaves: "Chaves",
        construcao: "Constru√ß√£o",
        equipamentos: "Equipamentos",
        estrutural: "Estrutural",
        ferramentas: "Ferramentas",
        gesso: "Gesso",
        impermeabilizacao: "Impermeabiliza√ß√£o",
        marcenaria: "Marcenaria",
        marmoraria: "Marmoraria",
        materiais: "Materiais",
        pavimentacao: "Pavimenta√ß√£o",
        persianas: "Persianas",
        pintura: "Pintura",
        "piso-vinilicos": "Piso Vin√≠licos",
        protecao: "Prote√ß√£o",
        serralheria: "Serralheria",
        tapecaria: "Tape√ßaria",
        vidracaria: "Vidra√ßaria",
      };

      const showToast = (message, type = "success", duration = 3000) => {
        const container = $("#toast-container");
        if (!container) return;
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, duration);
      };

      // === STATE ===
      let state = { materials: [], movements: [], currentSection: "dashboard" };

      const saveState = () => {
        try {
          localStorage.setItem(
            "estoqueMaster_materials",
            JSON.stringify(state.materials)
          );
          localStorage.setItem(
            "estoqueMaster_movements",
            JSON.stringify(state.movements)
          );
        } catch (e) {
          console.error(e);
          showToast("Erro ao salvar dados.", "danger");
        }
      };

      const getInitialMaterials = () => {
        const saved = localStorage.getItem("estoqueMaster_materials");
        if (saved) return JSON.parse(saved);
        return [
          {
            id: 1,
            name: "Furadeira de Impacto",
            sku: "85631",
            category: "ferramentas",
            quantity: 15,
            minQuantity: 5,
            resupplyQuantity: 10,
            alertPercentage: 40,
            description: "Furadeira 500W",
            isArchived: false,
          },
          {
            id: 2,
            name: "Saco de Cimento 50kg",
            sku: "36452",
            category: "construcao",
            quantity: 40,
            minQuantity: 10,
            resupplyQuantity: 20,
            alertPercentage: 40,
            description: "Cimento CPII",
            isArchived: false,
          },
          {
            id: 3,
            name: "Ma√ßaneta de Porta",
            sku: "98745",
            category: "marcenaria",
            quantity: 3,
            minQuantity: 5,
            resupplyQuantity: 10,
            alertPercentage: 40,
            description: "Ma√ßaneta cromada",
            isArchived: false,
          },
          {
            id: 5,
            name: "Chave Phillips M√©dia",
            sku: "78901",
            category: "ferramentas",
            quantity: 8,
            minQuantity: 3,
            resupplyQuantity: 10,
            alertPercentage: 40,
            description: "Chave com ponta imantada",
            isArchived: true,
          },
        ];
      };

      const getInitialMovements = () => {
        const saved = localStorage.getItem("estoqueMaster_movements");
        if (saved) return JSON.parse(saved);
        return [
          {
            id: 1,
            materialId: 1,
            type: "entrada",
            quantity: 10,
            date: "2025-11-10",
            reason: "Compra de estoque",
          },
          {
            id: 2,
            materialId: 3,
            type: "saida",
            quantity: 5,
            date: "2025-11-12",
            reason: "Manuten√ß√£o",
          },
        ];
      };

      state.materials = getInitialMaterials();
      state.movements = getInitialMovements();

      // === RENDER ===
      let _currentModalMaterial = null;

      const getResupplyAlertLevel = (m) => {
        const minQty = m.minQuantity || 0;
        const resupplyQty = m.resupplyQuantity || 0;
        const alertPercent = m.alertPercentage || 40;
        if (resupplyQty === 0) return minQty;
        return minQty + resupplyQty * (alertPercent / 100);
      };

      const getMaterialStatus = (m) => {
        if (m.isArchived) return { text: "Arquivado", class: "status-warning" };
        if (m.quantity === 0)
          return { text: "Sem Estoque", class: "status-danger" };

        const minQty = m.minQuantity || 0;
        if (m.quantity < minQty)
          return { text: "Estoque Cr√≠tico", class: "status-danger" };

        const alertLevel = getResupplyAlertLevel(m);
        if (m.quantity < alertLevel)
          return { text: "Ressuprimento", class: "status-warning" };

        return { text: "Em Estoque", class: "status-success" };
      };

      // === EVENTS & MAIN LOGIC ===
      document.addEventListener("DOMContentLoaded", () => {
        const el = {
          sidebar: $("#sidebar"),
          menuToggle: $("#menu-toggle"),
          themeToggle: $("#theme-toggle"),
          dashboard: $("#dashboard"),
          addMaterial: $("#add-material"),
          searchMaterial: $("#search-material"),
          stockSearch: $("#stock-search"),
          stockMovement: $("#stock-movement"),
          movementSearch: $("#movement-search"),
          materialReports: $("#material-reports"),
          settings: $("#settings"),
          materialForm: $("#material-form"),
          recentMaterials: $("#recent-materials"),
          totalItems: $("#total-items"),
          lowStock: $("#low-stock"),
          formCancel: $("#form-cancel"),
          searchMaterialInput: $("#search-material-input"),
          searchMaterialResults: $("#search-material-results"),
          stockStatusFilter: $("#stock-status-filter"),
          stockSearchResults: $("#stock-search-results"),
          movementForm: $("#movement-form"),
          movementSkuInput: $("#movement-sku-input"),
          movementMaterialName: $("#movement-material-name"),
          movementQuantity: $("#movement-quantity"),
          movementReason: $("#movement-reason"),
          movementSearchDate: $("#movement-search-date"),
          movementSearchResults: $("#movement-search-results"),
          reportTotalMaterials: $("#report-total-materials"),
          reportOutOfStock: $("#report-out-of-stock"),
          reportHighStock: $("#report-high-stock"),
          topMovementsReport: $("#top-movements-report"),
          resetDataBtn: $("#reset-data-btn"),
          exportDataBtn: $("#export-data-btn"),
          importFileInput: $("#import-file-input"),
          searchCategoryFilter: $("#search-category-filter"),
          searchSortFilter: $("#search-sort-filter"),
          searchShowArchived: $("#search-show-archived"),
          archiveMaterialBtn: $("#archive-material"),
          unarchiveMaterialBtn: $("#unarchive-material"),
          editMaterial: $("#edit-material"),
          categoryChartContainer: $("#category-chart-container"),
          btnThemeLight: $("#btn-theme-light"),
          btnThemeDark: $("#btn-theme-dark"),
          materialResupplyQuantity: $("#material-resupply-quantity"),
          materialAlertPercentage: $("#material-alert-percentage"),
          logoutBtn: $("#logout-btn"),
        };

        // Render Functions inside main scope to access 'el' easily
        const renderSection = (sectionId) => {
          [
            el.dashboard,
            el.addMaterial,
            el.searchMaterial,
            el.stockSearch,
            el.stockMovement,
            el.movementSearch,
            el.materialReports,
            el.settings,
          ].forEach((s) => (s.style.display = "none"));

          if (sectionId === "dashboard") {
            el.dashboard.style.display = "block";
            renderDashboard();
          } else if (sectionId === "add-material") {
            el.addMaterial.style.display = "block";
          } else if (sectionId === "search-material") {
            el.searchMaterial.style.display = "block";
            renderSearchMaterial();
          } else if (sectionId === "stock-search") {
            el.stockSearch.style.display = "block";
            renderStockSearch();
          } else if (sectionId === "stock-movement") {
            el.stockMovement.style.display = "block";
            el.movementForm.reset();
            el.movementMaterialName.textContent =
              "Digite o c√≥digo do material.";
            el.movementMaterialName.className = "neutral";
          } else if (sectionId === "movement-search") {
            el.movementSearch.style.display = "block";
            renderMovementSearch();
          } else if (sectionId === "material-reports") {
            el.materialReports.style.display = "block";
            renderMaterialReports();
          } else if (sectionId === "settings") {
            el.settings.style.display = "block";
          }

          state.currentSection = sectionId;
          updateActiveNav(sectionId);
        };

        const renderDashboard = () => {
          const activeMaterials = state.materials.filter((m) => !m.isArchived);
          const totalItems = activeMaterials.reduce(
            (sum, m) => sum + m.quantity,
            0
          );
          const lowStockCount = activeMaterials.filter((m) => {
            const alertLevel = getResupplyAlertLevel(m);
            return m.quantity < alertLevel && m.quantity > 0;
          }).length;

          el.totalItems.textContent = NUMBER_FORMAT.format(totalItems);
          el.lowStock.textContent = lowStockCount;

          const fragment = document.createDocumentFragment();
          if (activeMaterials.length > 0) {
            activeMaterials
              .slice(-4)
              .reverse()
              .forEach((m) => {
                const { text, class: cls } = getMaterialStatus(m);
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${m.name}</td><td>${m.sku}</td><td>${m.quantity}</td><td><span class="status ${cls}">${text}</span></td><td><a href="#" class="view-details" data-id="${m.id}">Detalhes</a></td>`;
                fragment.appendChild(tr);
              });
          } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="5" style="text-align: center;">Nenhum material ativo.</td>`;
            fragment.appendChild(tr);
          }
          el.recentMaterials.innerHTML = "";
          el.recentMaterials.appendChild(fragment);
        };

        const renderSearchMaterial = () => {
          const term = el.searchMaterialInput.value.toLowerCase();
          const category = el.searchCategoryFilter.value;
          const sort = el.searchSortFilter.value;
          const showArchived = el.searchShowArchived.checked;

          let results = state.materials.filter((m) =>
            showArchived ? m.isArchived : !m.isArchived
          );
          if (category !== "all")
            results = results.filter((m) => m.category === category);
          if (term)
            results = results.filter(
              (m) => m.name.toLowerCase().includes(term) || m.sku.includes(term)
            );

          if (sort === "name-asc")
            results.sort((a, b) => a.name.localeCompare(b.name));
          else if (sort === "name-desc")
            results.sort((a, b) => b.name.localeCompare(a.name));
          else if (sort === "qty-asc")
            results.sort((a, b) => a.quantity - b.quantity);
          else if (sort === "qty-desc")
            results.sort((a, b) => b.quantity - a.quantity);

          const fragment = document.createDocumentFragment();
          if (results.length > 0) {
            results.forEach((m) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${m.name}</td><td>${m.sku}</td><td>${
                CATEGORY_MAP[m.category] || m.category
              }</td><td>${m.quantity}</td><td>${
                m.minQuantity || 0
              }</td><td><a href="#" class="view-details" data-id="${
                m.id
              }">Detalhes</a></td>`;
              fragment.appendChild(tr);
            });
          } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="6" style="text-align: center;">Nenhum material encontrado.</td>`;
            fragment.appendChild(tr);
          }
          el.searchMaterialResults.innerHTML = "";
          el.searchMaterialResults.appendChild(fragment);
        };

        const renderStockSearch = () => {
          const filter = el.stockStatusFilter.value;
          const active = state.materials.filter((m) => !m.isArchived);
          let results = active;

          if (filter === "out")
            results = active.filter((m) => m.quantity === 0);
          else if (filter === "critical")
            results = active.filter((m) => m.quantity < (m.minQuantity || 0));
          else if (filter === "attention")
            results = active.filter(
              (m) => m.quantity < getResupplyAlertLevel(m)
            );

          const fragment = document.createDocumentFragment();
          if (results.length > 0) {
            results.forEach((m) => {
              const { text, class: cls } = getMaterialStatus(m);
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${m.name}</td><td>${m.quantity}</td><td>${
                m.minQuantity || 0
              }</td><td><span class="status ${cls}">${text}</span></td>`;
              fragment.appendChild(tr);
            });
          } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="4" style="text-align: center;">Nenhum material encontrado.</td>`;
            fragment.appendChild(tr);
          }
          el.stockSearchResults.innerHTML = "";
          el.stockSearchResults.appendChild(fragment);
        };

        const renderMovementSearch = () => {
          const date = el.movementSearchDate.value;
          let results = [...state.movements].reverse();
          if (date) results = results.filter((m) => m.date === date);

          const fragment = document.createDocumentFragment();
          if (results.length > 0) {
            results.forEach((m) => {
              const mat = state.materials.find((x) => x.id === m.materialId);
              const typeCls = m.type === "entrada" ? "success" : "danger";
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${m.date}</td><td>${
                mat ? mat.name : "Desconhecido"
              } ${
                mat?.isArchived ? "(Arq)" : ""
              }</td><td><span class="status status-${typeCls}">${
                m.type
              }</span></td><td>${m.quantity}</td><td>${m.reason}</td>`;
              fragment.appendChild(tr);
            });
          } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="5" style="text-align: center;">Nenhuma movimenta√ß√£o.</td>`;
            fragment.appendChild(tr);
          }
          el.movementSearchResults.innerHTML = "";
          el.movementSearchResults.appendChild(fragment);
        };

        const renderMaterialReports = () => {
          const active = state.materials.filter((m) => !m.isArchived);
          el.reportTotalMaterials.textContent = active.length;
          el.reportOutOfStock.textContent = active.filter(
            (m) => m.quantity === 0
          ).length;
          el.reportHighStock.textContent = active.filter(
            (m) => m.quantity > 20
          ).length;

          const catCounts = {};
          active.forEach(
            (m) => (catCounts[m.category] = (catCounts[m.category] || 0) + 1)
          );
          const max = Math.max(0, ...Object.values(catCounts));
          let chart = "";
          Object.entries(catCounts)
            .sort((a, b) => b[1] - a[1])
            .forEach(([k, v]) => {
              const pct = max > 0 ? (v / max) * 100 : 0;
              chart += `<div class="chart-row"><div class="chart-label">${
                CATEGORY_MAP[k] || k
              }</div><div class="chart-bar-background"><div class="chart-bar" style="width: ${pct}%"></div></div><div class="chart-value">${v}</div></div>`;
            });
          el.categoryChartContainer.innerHTML = chart || "<p>Sem dados.</p>";

          const movCount = {};
          state.movements.forEach(
            (m) =>
              (movCount[m.materialId] =
                (movCount[m.materialId] || 0) + m.quantity)
          );
          const sorted = Object.entries(movCount)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
          const fragment = document.createDocumentFragment();
          sorted.forEach(([id, total]) => {
            const m = state.materials.find((x) => x.id === Number(id));
            if (m) {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${m.name}</td><td>${total}</td>`;
              fragment.appendChild(tr);
            }
          });
          if (sorted.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="2" style="text-align: center;">Sem dados.</td>`;
            fragment.appendChild(tr);
          }
          el.topMovementsReport.innerHTML = "";
          el.topMovementsReport.appendChild(fragment);
        };

        const updateActiveNav = (target) => {
          $$(".nav-item").forEach((item) => {
            if (item.getAttribute("data-target") === target)
              item.classList.add("active");
            else item.classList.remove("active");
          });
        };

        const closeModal = () => {
          const modal = $("#material-modal");
          modal.classList.remove("fade-in");
          setTimeout(() => (modal.style.display = "none"), 300);
        };

        const openMaterialModal = (m) => {
          _currentModalMaterial = m;
          const { text, class: cls } = getMaterialStatus(m);
          const cat = CATEGORY_MAP[m.category] || m.category;
          const modalBody = $("#modal-body");

          modalBody.innerHTML = `
          <p><strong>Nome:</strong> <span>${m.name}</span></p>
          <p><strong>C√ìDIGO:</strong> <span>${m.sku}</span></p>
          <p><strong>Categoria:</strong> <span>${cat}</span></p>
          <p><strong>Qtd. Atual:</strong> <span>${m.quantity}</span></p>
          <p><strong>Qtd. M√≠nima:</strong> <span>${
            m.minQuantity || 0
          }</span></p>
          <p><strong>Ressuprimento:</strong> <span>${
            m.resupplyQuantity || 0
          }</span></p>
          <p><strong>% Alerta:</strong> <span>${
            m.alertPercentage || 40
          }%</span></p>
          <p><strong>Status:</strong> <span class="status ${cls}">${text}</span></p>
          ${
            m.description
              ? `<p><strong>Descri√ß√£o:</strong></p><p>${m.description}</p>`
              : ""
          }
        `;

          if (m.isArchived) {
            el.archiveMaterialBtn.style.display = "none";
            el.unarchiveMaterialBtn.style.display = "inline-flex";
            el.editMaterial.style.display = "none";
          } else {
            el.archiveMaterialBtn.style.display = "inline-flex";
            el.unarchiveMaterialBtn.style.display = "none";
            el.editMaterial.style.display = "inline-flex";
          }

          $("#material-modal").style.display = "flex";
          $("#material-modal").offsetHeight;
          $("#material-modal").classList.add("fade-in");
        };

        // Listeners
        document.addEventListener("click", (e) => {
          const navLink = e.target.closest("a[data-target]");
          if (navLink) {
            e.preventDefault();
            renderSection(navLink.getAttribute("data-target"));
          }
          const details = e.target.closest(".view-details");
          if (details) {
            e.preventDefault();
            const m = state.materials.find(
              (x) => x.id === Number(details.dataset.id)
            );
            if (m) openMaterialModal(m);
          }
          if (e.target.hasAttribute("data-close")) closeModal();
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        el.menuToggle?.addEventListener("click", () =>
          el.sidebar.classList.add("open")
        );
        document.addEventListener("click", (e) => {
          if (
            window.innerWidth <= 768 &&
            !el.sidebar.contains(e.target) &&
            e.target !== el.menuToggle
          ) {
            el.sidebar.classList.remove("open");
          }
        });

        // Theme
        const setTheme = (isDark) => {
          if (isDark) {
            document.body.classList.add("dark-theme");
            el.btnThemeDark.classList.add("active");
            el.btnThemeLight.classList.remove("active");
          } else {
            document.body.classList.remove("dark-theme");
            el.btnThemeLight.classList.add("active");
            el.btnThemeDark.classList.remove("active");
          }
          localStorage.setItem("dark-theme", isDark);
        };
        el.btnThemeLight.addEventListener("click", () => setTheme(false));
        el.btnThemeDark.addEventListener("click", () => setTheme(true));
        if (localStorage.getItem("dark-theme") === "true") setTheme(true);

        // Form Submit
        el.materialForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const id = Number($("#material-id").value);
          const mat = {
            id: id || Date.now(),
            name: $("#material-name").value.trim(),
            sku: $("#material-sku").value.trim(),
            category: $("#material-category").value,
            quantity: Number($("#material-quantity").value),
            minQuantity: Number($("#material-min-quantity").value),
            resupplyQuantity: Number($("#material-resupply-quantity").value),
            alertPercentage: Number($("#material-alert-percentage").value),
            description: $("#material-description").value.trim(),
            isArchived: false,
          };

          const exists = state.materials.find(
            (m) => m.sku === mat.sku && m.id !== mat.id
          );
          if (exists) {
            showToast("SKU j√° existe!", "danger");
            return;
          }

          const idx = state.materials.findIndex((m) => m.id === mat.id);
          if (idx >= 0) {
            mat.isArchived = state.materials[idx].isArchived;
            state.materials[idx] = mat;
            showToast("Atualizado!", "success");
          } else {
            state.materials.push(mat);
            showToast("Criado!", "success");
          }
          saveState();
          el.materialForm.reset();
          // Reset defaults
          $("#material-min-quantity").value = 0;
          $("#material-resupply-quantity").value = 0;
          $("#material-alert-percentage").value = 40;
          renderSection("dashboard");
        });

        el.formCancel.addEventListener("click", () => {
          el.materialForm.reset();
          renderSection("dashboard");
        });

        // Inputs & Filters
        el.searchMaterialInput.addEventListener("input", () =>
          renderSearchMaterial()
        );
        el.searchCategoryFilter.addEventListener("change", () =>
          renderSearchMaterial()
        );
        el.searchSortFilter.addEventListener("change", () =>
          renderSearchMaterial()
        );
        el.searchShowArchived.addEventListener("change", () =>
          renderSearchMaterial()
        );
        el.stockStatusFilter.addEventListener("change", () =>
          renderStockSearch()
        );
        el.movementSearchDate.addEventListener("change", () =>
          renderMovementSearch()
        );

        el.movementSkuInput.addEventListener("input", () => {
          const sku = el.movementSkuInput.value.trim();
          if (!sku) {
            el.movementMaterialName.textContent = "Digite o c√≥digo.";
            el.movementMaterialName.className = "neutral";
            return;
          }
          const m = state.materials.find((x) => x.sku === sku && !x.isArchived);
          if (m) {
            el.movementMaterialName.textContent = `${m.name} (Qtd: ${m.quantity})`;
            el.movementMaterialName.className = "success";
          } else {
            el.movementMaterialName.textContent = "N√£o encontrado.";
            el.movementMaterialName.className = "danger";
          }
        });

        el.movementForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const sku = el.movementSkuInput.value.trim();
          const m = state.materials.find((x) => x.sku === sku && !x.isArchived);
          const type = document.querySelector(
            'input[name="movement-type"]:checked'
          )?.value;
          const qty = Number(el.movementQuantity.value);

          if (!m) {
            showToast("Material inv√°lido.", "danger");
            return;
          }
          if (type === "saida" && m.quantity < qty) {
            showToast("Estoque insuficiente.", "danger");
            return;
          }

          m.quantity += type === "entrada" ? qty : -qty;
          state.movements.push({
            id: Date.now(),
            materialId: m.id,
            type,
            quantity: qty,
            date: new Date().toISOString().split("T")[0],
            reason: el.movementReason.value.trim(),
          });
          saveState();
          showToast("Movimenta√ß√£o registrada!", "success");
          el.movementForm.reset();
          el.movementMaterialName.textContent = "Digite o c√≥digo.";
          el.movementMaterialName.className = "neutral";
          if (state.currentSection === "dashboard") renderDashboard();
        });

        // Modal Actions
        el.editMaterial.addEventListener("click", () => {
          const m = _currentModalMaterial;
          if (!m) return;
          $("#material-id").value = m.id;
          $("#material-name").value = m.name;
          $("#material-sku").value = m.sku;
          $("#material-category").value = m.category;
          $("#material-quantity").value = m.quantity;
          $("#material-min-quantity").value = m.minQuantity || 0;
          $("#material-resupply-quantity").value = m.resupplyQuantity || 0;
          $("#material-alert-percentage").value = m.alertPercentage || 40;
          $("#material-description").value = m.description || "";
          closeModal();
          renderSection("add-material");
        });

        el.archiveMaterialBtn.addEventListener("click", () => {
          const m = _currentModalMaterial;
          if (m && confirm("Arquivar este item?")) {
            state.materials.find((x) => x.id === m.id).isArchived = true;
            saveState();
            closeModal();
            showToast("Arquivado!", "success");
            renderSection(state.currentSection);
          }
        });

        el.unarchiveMaterialBtn.addEventListener("click", () => {
          const m = _currentModalMaterial;
          if (m) {
            state.materials.find((x) => x.id === m.id).isArchived = false;
            saveState();
            closeModal();
            showToast("Restaurado!", "success");
            renderSection(state.currentSection);
          }
        });

        // Data Management
        const resetData = () => {
          if (confirm("Tem certeza?")) {
            localStorage.removeItem("estoqueMaster_materials");
            localStorage.removeItem("estoqueMaster_movements");
            showToast("Redefinido!", "success");
            setTimeout(() => location.reload(), 1000);
          }
        };
        el.resetDataBtn.addEventListener("click", resetData);
        el.logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          location.reload();
        }); // Reload only

        el.exportDataBtn.addEventListener("click", () => {
          if (state.materials.length === 0) {
            showToast("Sem dados.", "warning");
            return;
          }
          const data = JSON.stringify(
            { materials: state.materials, movements: state.movements },
            null,
            2
          );
          const blob = new Blob([data], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "backup.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          showToast("Backup salvo!", "success");
        });

        el.importFileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          if (confirm("Substituir dados?")) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              try {
                const data = JSON.parse(ev.target.result);
                if (Array.isArray(data.materials)) {
                  state.materials = data.materials;
                  state.movements = data.movements || [];
                  saveState();
                  showToast("Dados restaurados!", "success");
                  renderSection("dashboard");
                }
              } catch (err) {
                showToast("Erro no arquivo.", "danger");
              }
            };
            reader.readAsText(file);
          }
        });

        // Print
        $("#print-modal").addEventListener("click", () => {
          const content = $("#modal-body").innerHTML;
          const win = window.open("", "_blank");
          win.document.write(
            `<html><head><title>Imprimir</title></head><body>${content}</body></html>`
          );
          win.document.close();
          win.print();
          win.close();
        });

        // Init
        renderSection("dashboard");
        document.getElementById("material-submenu").classList.add("open");
        document
          .querySelector('[data-target="material-submenu"] .arrow')
          .classList.add("rotate");
      });
    </script>
  </body>
</html>
